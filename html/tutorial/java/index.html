<!DOCTYPE html>
<html>
 <head>
  <title>CloudI Java Tutorial</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="css/themes/Vines.css" />
  <link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" />
  <!-- http://code.jquery.com/mobile/1.4.5/jquery.mobile.structure-1.4.5.min.css -->
  <link rel="stylesheet" href="css/jquery.mobile.structure-1.4.5.min.css" />
  <!-- http://code.jquery.com/jquery-1.11.1.min.js -->
  <script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
  <!-- http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js -->
  <script type="text/javascript" src="js/jquery.mobile-1.4.5.min.js"></script>
 </head>
 <body>
  <!-- start of recommendation page -->
  <div data-role="page" id="recommendation_page">
   <!-- start of header -->
   <div data-role="header" data-theme="b">
    <h1>CloudI Java Tutorial</h1>
   </div>
   <!-- end header -->
   <form name="recommendation_form" id="recommendation_form">
    <div class="ui-field-contain">
     <label for="user_id">user_id </label>
     <input type="text" name="user_id" id="user_id" value="" />
    </div>
    <div class="ui-field-contain">
     <label for="language">language </label>
     <select name="language" id="language">
      <option value="0" selected></option>
     </select>
    </div>
    <div class="ui-field-contain">
     <label for="subject">subject </label>
     <select name="subject" id="subject">
      <option value="0" selected></option>
     </select>
    </div>
    <!-- start of content -->
    <div data-role="content" data-theme="b">
     <!-- display rating list -->
     <div name="rating_section" id="rating_section">
      <p>
       Please rate the following items on a scale from 0.5 to 5
       with 5 being highest
      </p>
      <div name="rating_list" id="rating_list">
      </div> 
     </div>
     <!-- display recommendations -->
     <div name="recommendation_section" id="recommendation_section">
      <p>You might also like:</p>
      <ul name="recommendation_list" id="recommendation_list"
          data-role="listview" data-inset="true">
      </ul>
     </div>
    </div>
    <!-- end of content -->
   </form>
   <!-- start footer -->
   <div data-role="footer">
    <p align="right" id="connection_status"></p>
   </div>
  </div>
   <!-- end footer -->

  </div>
  <!-- end of recommendation page -->
  <script type="text/javascript">

var websocket = undefined;

function element_event_send(element, event_name) {
    var standard_browser = document.createEvent;
    var e;
    if (standard_browser) {
        e = document.createEvent("HTMLEvents");
        e.initEvent(event_name, true, true);
    }
    else {
        e = document.createEventObject();
        e.eventType = event_name;
    }
    e.eventName = event_name;
    if (standard_browser) {
        element.dispatchEvent(e);
    }
    else {
        element.fireEvent("on" + e.eventType, e);
    }
}

function element_event_handler_add(element, event_name, f) {
    if (element.attachEvent) {
        element["e" + event_name + f] = f;
        element[event_name + f] = function() {
            element["e" + event_name + f](window.event);
        }
        element.attachEvent("on" + event_name, element[event_name + f]);
    }
    else {
        element.addEventListener(event_name, f, false);
    }
}

function element_event_handler_remove(element, event_name, f) {
    if (element.detachEvent) {
        element.detachEvent("on" + event_name, element[event_name + f]);
        element[event_name + f] = null;
        element["e" + event_name + f] = null;
    }
    else {
        element.removeEventListener(event_name, f, false);
    }
}

function options_set_first(id, value) {
    var select = document.getElementById(id);
    var option = select.options[0];
    option.text = value;
    element_event_send(select, "change");
}

function options_update(id, list, field) {
    var select = document.getElementById(id);
    var current = select.options[select.selectedIndex].text;
    var i;
    // remove all the current entries
    for(i = select.options.length - 1; i >= 0; i--) {
        select.remove(i);
    }
    // add all the new entries
    var current_i = undefined;
    for (i = 0; i < list.length; i++) {
        var value = list[i][field];
        var option = document.createElement("option");
        option.value = i;
        option.text = value;
        if (value == current) {
            option.selected = true;
            current_i = i;
        }
        select.add(option, i);
    }
    // use the old selection as the current selection, if present
    if (typeof current_i !== undefined) {
        select.selectedIndex = current_i;
    }
    else {
        select.selectedIndex = 0;
    }
    element_event_send(select, 'change');
}

function options_selected_store(id, field) {
    var select = document.getElementById(id);
    var current = select.options[select.selectedIndex].text;
    localStorage[field] = current;
}

function store_user_id_set() {
    localStorage["user_id"] = document.getElementById("user_id").value;
}

function store_language_set() {
    options_selected_store("language", "language");
}

function store_subject_set() {
    options_selected_store("subject", "subject");
}

function display_connection_status(value) {
    var p = document.getElementById("connection_status");
    p.innerHTML = value;
}

function display_language_list(obj) {
    options_update("language", obj.languages, "language");
}

function display_subject_list(obj) {
    options_update("subject", obj.subjects, "subject");
}

function select_item(item_id) {
    console.log("selected item " + item_id);

    // call the item detail web page
    location.assign("itemdetail.html?id=" + item_id);
}

function display_recommendation_list(obj) {
    console.log("display_recommendation_list()");

    // add items to the list
    var items_found = false;
    var i;
    var list = obj.recommendations;
    for (i = 0; i < list.length; i++) {
        var item = list[i];
//        console.log("Item ID = " + item.id);
        var tag =
"<li><a data-icon=\"arrow-r\" data-iconpos=\"right\" " +
  "onclick=\"select_item('" + item.item_id + "'); return false;\">" +
item.title +
"</a></li>";
        $("#recommendation_list").append(tag).listview('refresh');
        items_found = true;
    }
    if (items_found == true) {
        // show the recommendation section div
        $("#recommendation_section").show();
    }
    else {
        // hide the recommendation section div
        $("#recommendation_section").hide();
    }
}

function select_rating(item_id) {
    console.log("select_rating(" + item_id + ")");     
    var user_id = document.getElementById("user_id").value;
    var rating = $("#slider" + item_id).val();
    var recommendation_update = {
        message_name: "recommendation_update",
        user_id: user_id,
        item_id: item_id,
        rating: rating
    }; 
    websocket_send(recommendation_update);
}

function display_item_list(obj) {
    console.log("display_items_list()");

    // add items to the list
    var items_found = false;
    $.each(obj.items, function (i, item) {
        //console.log("Item ID = " + item.id);

        var slider_id = "slider" + item.id;
        var tag =
"<div class=\"ui-field-contain\">" +
"<div data-role=\"rangeslider\">" +
"<label for=\"" + slider_id + "\">" + item.title + "</label>" +
"<input class=\"myslide\" type=\"range\" name=\""  + slider_id +
  "\" id=\"" + slider_id + "\" value=\"" + item.rating +
  "\" min=\"0.5\" max=\"5.0\" " +
  "data-highlight=\"true\" data-id=\"" + item.id + "\" data-mini=\"true\" />" +
"</div>" +
"<div data-role=\"fieldcontain\">" +
"<input type=\"button\" value=\"Rate\" id=\"btn" + item.id +
  "\" data-icon=\"check\" data-inline=\"true\" " +
  "onclick=\"select_rating(" + item.id + "); return false;\" />" +
"</div>" +
"</div>";
        console.log("tag=" + tag);
return;

        $("#rating_list").append(tag);
        items_found=true;
    });
    if (items_found == true) {
        // ask the DIV to apply the correct style to the new sliders
        $("#rating_list").enhanceWithin();

        // show the rating section div
        $("#rating_section").show();
    }
    else {
        // hide the rating section div
        $("#rating_section").hide();
    }
}

function websocket_send(data_object) {
    if (websocket == undefined) {
        alert("Not connected!");
        return;
    }
    var data = JSON.stringify(data_object, null, 2);
    websocket.send(data);
    console.log("websocket sent: " + data);
}

// called when the web page has finished loading    
$(document).ready(function () {
    console.log("loaded, running javascript...");

//XXX
$("#rating_section").hide();
$("#recommendation_section").hide();

    // get the user data from HTML5 storage if it has been stored
    var user_id = "1";
    var language = "en";
    var subject = "Philosophy";
    if (typeof Storage !== "undefined") {
        // Web Storage support available
        var user_id_stored = localStorage.user_id;
        if (typeof user_id_stored == 'string') {
            user_id = user_id_stored;
        }
        else {
            localStorage.user_id = user_id;
        }
        var language_stored = localStorage.language;
        if (typeof language_stored == 'string') {
            language = language_stored;
        }
        else {
            localStorage.language = language;
        }
        var subject_stored = localStorage.subject;
        if (typeof subject_stored == 'string') {
            subject = subject_stored;
        }
        else {
            localStorage.subject = subject;
        }
    }
    else {
        // Web Storage support unavailable
        alert("HTML5 is required!");
        return;
    }
    document.getElementById("user_id").value = user_id;
    options_set_first("language", language);
    options_set_first("subject", subject);
    console.log("user_id = " + user_id);
    console.log("language = " + language);
    console.log("subject = " + subject);
    // create a WebSocket connection for protocol usage
    var host = "127.0.0.1";
    var port = "8080";
    var service_name = "/tutorial/java/service/client";
    if (typeof WebSocket !== "function") {
        alert("WebSocket support is required!");
        return;
    }
    var websocket_url = "ws://" + host + ":" + port + service_name;
    websocket = new WebSocket(websocket_url);
    console.log("websocket connecting to " + websocket_url);
    display_connection_status("Connecting");
    websocket.onopen = function() {
        console.log("websocket connected");
        display_connection_status("Connected");

        // update the language selection options
        var language_list = {
            message_name: "language_list"
        }; 
        websocket_send(language_list);

        // update the subject selection options
        var subject_list = {
            message_name: "subject_list"
        }; 
        websocket_send(subject_list);

        // add local storage events
        element_event_handler_add(document.getElementById("user_id"),
                                  "input", store_user_id_set);
        element_event_handler_add(document.getElementById("language"),
                                  "change", store_language_set);
        element_event_handler_add(document.getElementById("subject"),
                                  "change", store_subject_set);
/*XXX
        var user_id = document.getElementById("user_id").value;
        var item_list = {
            message_name: "item_list",
            user_id: user_id,
            language: language
        }; 
        //websocket_send(item_list);
        */
    };
    websocket_message = function (data) {
        var data_object = JSON.parse(data);
        if (data_object.success !== true) {
            if (typeof data_object.error === "string") {
                console.log("websocket error: " + data_object.error);
            }
            else {
                console.log("websocket invalid message: " + data);
            }
            return;
        }
        console.log("websocket received: " + data);
        switch (data_object.message_name) {
            case "recommendation_update":
                display_connection_status("Rating saved");
                break;
            case "recommendation_list":
                display_connection_status("Displaying data");
                display_connection_status("");
                break;
            case "recommendation_refresh":
                break;
            case "item_list":
                display_item_list(data_object);
                break;
            case "item_refresh":
                break;
            case "language_list":
                display_language_list(data_object);
                break;
            case "subject_list":
                display_subject_list(data_object);
                break;
            default:
                console.log("websocket message \"" +
                            data_object.message_name + "\" not implemented");
                break;
        }
    };
    websocket.onmessage = function (evt) {
        var data = evt.data;
        if (data instanceof Blob) {
            // binary is received and used as text
            var reader = new FileReader();
            reader.readAsText(data, "text/plain");
            reader.onload = function (reader_evt) {
                data = reader_evt.target.result;
                websocket_message(data);
            };
        }
        else {
            // text is received
            websocket_message(data);
        }
    };
    websocket.onclose = function() {
        websocket = undefined;
        console.log("websocket disconnected");
        display_connection_status("Disconnected");
        // remove local storage events
        element_event_handler_remove(document.getElementById("user_id"),
                                     "input");
        element_event_handler_remove(document.getElementById("language"),
                                     "change");
        element_event_handler_remove(document.getElementById("subject"),
                                     "change");
    };
});

  </script>
 </body>
</html>
